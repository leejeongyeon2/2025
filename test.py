import streamlit as st
import numpy as np
from hashlib import sha256
import pandas as pd

# ì•± ê¸°ë³¸ ì„¤ì • (íƒ€ì´í‹€/ì•„ì´ì½˜)
st.set_page_config(page_title="ğŸ’˜ ì—°ì•  ëŠ¥ë ¥ì¹˜ í…ŒìŠ¤íŠ¸ ğŸ’˜", page_icon="ğŸ’–")

# ğŸŒŸ ë©”ì¸ íƒ€ì´í‹€ ì¶œë ¥
st.markdown("<h1 style='text-align:center;'>ğŸ’– ì—°ì•  ëŠ¥ë ¥ì¹˜ í…ŒìŠ¤íŠ¸ ğŸ’–</h1>", unsafe_allow_html=True)
st.markdown("<p style='text-align:center;'>âœ¨ ë‚˜ì˜ ì—°ì•  ëŠ¥ë ¥ì¹˜ë¥¼ í™•ì¸í•´ë³´ì„¸ìš”! âœ¨</p>", unsafe_allow_html=True)

# ëŠ¥ë ¥ì¹˜ ì¹´í…Œê³ ë¦¬ ì •ì˜
CATS = ["ğŸ’ ë§¤ë ¥", "ğŸ­ ì„¼ìŠ¤", "ğŸ’° ì¬ë ¥", "ğŸ“± ì§‘ì°©", "ğŸŒŸ ì¸ê¸°ë„"]

# ì§ˆë¬¸ ë¦¬ìŠ¤íŠ¸ (ê° ì§ˆë¬¸ì€ ì–´ë–¤ ì¹´í…Œê³ ë¦¬ì— ì†í•˜ëŠ”ì§€ í•¨ê»˜ ì €ì¥)
questions = [
    {"q": "ğŸ‘— ì²« ë§Œë‚¨ì—ì„œ ì™¸ëª¨/íŒ¨ì…˜ì— ì‹ ê²½ì„ ì“´ë‹¤", "cat": "ğŸ’ ë§¤ë ¥"},
    {"q": "ğŸ˜ ìì‹ ë§Œì˜ ë§¤ë ¥ í¬ì¸íŠ¸(ìœ ë¨¸, ë¶„ìœ„ê¸° ë“±)ê°€ ìˆë‹¤", "cat": "ğŸ’ ë§¤ë ¥"},
    {"q": "ğŸ’¬ ìì‹ ê° ìˆê²Œ ë§í•˜ëŠ” í¸ì´ë‹¤", "cat": "ğŸ’ ë§¤ë ¥"},
    {"q": "ğŸ‘€ í˜¸ê° ìˆëŠ” ì‚¬ëŒì—ê²Œ ëˆˆì„ ì˜ ë§ì¶˜ë‹¤", "cat": "ğŸ’ ë§¤ë ¥"},

    {"q": "ğŸ‘‚ ìƒëŒ€ë°©ì˜ ê¸°ë¶„ ë³€í™”ë¥¼ ì˜ ëˆˆì¹˜ì±ˆë‹¤", "cat": "ğŸ­ ì„¼ìŠ¤"},
    {"q": "ğŸ˜‚ ëŒ€í™” ì¤‘ ì ì ˆí•œ ë†ë‹´ì„ ì˜ ë˜ì§„ë‹¤", "cat": "ğŸ­ ì„¼ìŠ¤"},
    {"q": "ğŸ ì„ ë¬¼ ê³ ë¥´ëŠ” ì„¼ìŠ¤ê°€ ìˆë‹¤ëŠ” ë§ì„ ìì£¼ ë“£ëŠ”ë‹¤", "cat": "ğŸ­ ì„¼ìŠ¤"},
    {"q": "ğŸ¤² ë§ë³´ë‹¤ í–‰ë™ìœ¼ë¡œ ì±™ê²¨ì£¼ëŠ” í¸ì´ë‹¤", "cat": "ğŸ­ ì„¼ìŠ¤"},

    {"q": "ğŸ½ï¸ ë°ì´íŠ¸ ë¹„ìš©ì„ ë¬´ë¦¬ ì—†ì´ ê°ë‹¹í•  ìˆ˜ ìˆë‹¤", "cat": "ğŸ’° ì¬ë ¥"},
    {"q": "ğŸ’³ ìƒëŒ€ë°©ì—ê²Œ ì—¬ìœ  ìˆì–´ ë³´ì¸ë‹¤ëŠ” ë§ì„ ë“£ëŠ”ë‹¤", "cat": "ğŸ’° ì¬ë ¥"},
    {"q": "ğŸ“Š ëˆ ê´€ë¦¬(ì €ì¶•, ì†Œë¹„)ë¥¼ ì˜ í•˜ëŠ” í¸ì´ë‹¤", "cat": "ğŸ’° ì¬ë ¥"},
    {"q": "ğŸ‰ ê¸°ë…ì¼ì— ì´ë²¤íŠ¸/ì„ ë¬¼ì„ ì•„ë¼ì§€ ì•ŠëŠ”ë‹¤", "cat": "ğŸ’° ì¬ë ¥"},

    {"q": "ğŸ“ ì—°ì¸ì—ê²Œ í•˜ë£¨ì— ì—¬ëŸ¬ ë²ˆ ì—°ë½í•´ì•¼ ì•ˆì‹¬ëœë‹¤", "cat": "ğŸ“± ì§‘ì°©"},
    {"q": "ğŸ” ìƒëŒ€ë°©ì˜ SNS í™œë™ì„ ìì£¼ í™•ì¸í•œë‹¤", "cat": "ğŸ“± ì§‘ì°©"},
    {"q": "ğŸ˜  ì—°ì¸ì´ ì¹œêµ¬ì™€ ë” ë§ì€ ì‹œê°„ì„ ë³´ë‚´ë©´ ì‹ ê²½ ì“°ì¸ë‹¤", "cat": "ğŸ“± ì§‘ì°©"},
    {"q": "âŒ› ì‚¬ì†Œí•œ ì—°ë½ ì§€ì—°ì—ë„ ë¶ˆì•ˆí•´í•˜ëŠ” í¸ì´ë‹¤", "cat": "ğŸ“± ì§‘ì°©"},

    {"q": "ğŸ‘‹ ì²˜ìŒ ë³´ëŠ” ì‚¬ëŒê³¼ë„ ê¸ˆë°© ì¹œí•´ì§„ë‹¤", "cat": "ğŸŒŸ ì¸ê¸°ë„"},
    {"q": "ğŸ¥³ ì¹œêµ¬ë“¤ ì‚¬ì´ì—ì„œ ì£¼ëª©ë°›ëŠ” í¸ì´ë‹¤", "cat": "ğŸŒŸ ì¸ê¸°ë„"},
    {"q": "ğŸ˜ ì—¬ëŸ¬ ì‚¬ëŒì—ê²Œ í˜¸ê°ì„ ë°›ëŠ”ë‹¤ê³  ëŠë‚€ ì  ìˆë‹¤", "cat": "ğŸŒŸ ì¸ê¸°ë„"},
    {"q": "ğŸ’Œ ì†Œê°œíŒ… ì œì•ˆì„ ìì£¼ ë°›ëŠ”ë‹¤", "cat": "ğŸŒŸ ì¸ê¸°ë„"},
]

# ì‚¬ìš©ì ë‹‰ë„¤ì„ ì…ë ¥
name = st.text_input("âœï¸ ë‹‰ë„¤ì„ì„ ì…ë ¥í•˜ì„¸ìš”", value="")

# ì„¸ì…˜ ìƒíƒœ ì´ˆê¸°í™” (ì§ˆë¬¸ ê°œìˆ˜ê°€ ë°”ë€Œë©´ ë‹¤ì‹œ ì´ˆê¸°í™”ë¨)
if "answers" not in st.session_state or len(st.session_state.answers) != len(questions):
    st.session_state.answers = [3] * len(questions)  # ê¸°ë³¸ê°’ 3(ë³´í†µ)ìœ¼ë¡œ ì„¤ì •

# ë¬¸í•­ ì¶œë ¥ (ìŠ¬ë¼ì´ë”ë¡œ ë‹µë³€)
st.subheader("âœ¨ ì§ˆë¬¸ì— ë‹µí•´ì£¼ì„¸ìš” âœ¨")
for i, item in enumerate(questions):
    st.session_state.answers[i] = st.slider(
        item["q"], 1, 5, st.session_state.answers[i], key=f"q_{i}"
    )

# ì ìˆ˜ ê³„ì‚° í•¨ìˆ˜
def compute_scores(answers, questions):
    raw = {c: 0 for c in CATS}  # ì¹´í…Œê³ ë¦¬ë³„ ì ìˆ˜ í•©
    cnt = {c: 0 for c in CATS}  # ì¹´í…Œê³ ë¦¬ë³„ ì§ˆë¬¸ ê°œìˆ˜
    for val, item in zip(answers, questions):
        raw[item["cat"]] += val
        cnt[item["cat"]] += 1
    scores = {}
    for c in CATS:
        avg = (raw[c] / cnt[c]) if cnt[c] else 0
        scores[c] = round((avg - 1) / 4 * 100)  # 1~5 ì ìˆ˜ë¥¼ 0~100ìœ¼ë¡œ í™˜ì‚°
    return scores

# ë²„íŠ¼ 2ê°œ (ê²°ê³¼ ë³´ê¸°, ë¦¬ì…‹)
col1, col2 = st.columns(2)
show = col1.button("ğŸ’˜ ê²°ê³¼ ë³´ê¸° ğŸ’˜")
reset = col2.button("ğŸ”„ ì²˜ìŒë¶€í„° ë‹¤ì‹œí•˜ê¸°")

# ë¦¬ì…‹ ë²„íŠ¼ ëˆŒë €ì„ ë•Œ
if reset:
    st.session_state.answers = [3] * len(questions)
    st.rerun()  # í˜ì´ì§€ ìƒˆë¡œê³ ì¹¨

# ê²°ê³¼ ë³´ê¸° ë²„íŠ¼ ëˆŒë €ì„ ë•Œ
if show:
    scores = compute_scores(st.session_state.answers, questions)  # ì ìˆ˜ ê³„ì‚°

    # ğŸ“Š ì‹œê°í™” (ë°” ì°¨íŠ¸)
    df = pd.DataFrame({
        "ëŠ¥ë ¥ì¹˜": list(scores.keys()),
        "ì ìˆ˜": list(scores.values())
    }).set_index("ëŠ¥ë ¥ì¹˜")

    st.markdown("### ğŸ“Š ë‚˜ì˜ ì—°ì•  ëŠ¥ë ¥ì¹˜ ê·¸ë˜í”„")
    st.bar_chart(df)  # bar chart ì¶œë ¥

    # ê²°ê³¼ ìš”ì•½ (ê°€ì¥ ë†’ì€ ì ìˆ˜ 2ê°œ + ê°€ì¥ ë‚®ì€ ì ìˆ˜ 1ê°œ)
    top_sorted = sorted(scores.items(), key=lambda x: x[1], reverse=True)
    low_sorted = sorted(scores.items(), key=lambda x: x[1])
    top1, top2 = top_sorted[0], top_sorted[1]
    low1 = low_sorted[0]

    st.subheader("ğŸŒˆ ê²°ê³¼ ìš”ì•½")
    st.write(f"ğŸ’– ê°•ì : **{top1[0]}({top1[1]}ì )**, **{top2[0]}({top2[1]}ì )**")
    st.write(f"ğŸ’” ë³´ì™„ í¬ì¸íŠ¸: **{low1[0]}({low1[1]}ì )**")

    # ì´í‰ (í•­ìƒ ê°™ì€ ë‹µë³€ì´ë©´ ê°™ì€ ë©˜íŠ¸ ë‚˜ì˜¤ë„ë¡ sha256 ì‚¬ìš©)
    seed_str = f"{name}-{st.session_state.answers}"
    idx = int(sha256(seed_str.encode()).hexdigest(), 16) % 5
    comments = [
        "ğŸ”¥ ë¶ˆê½ƒ ì¹´ë¦¬ìŠ¤ë§ˆ! ì‚¬ë‘ ì•ì—ì„œëŠ” ëˆ„êµ¬ë„ ëª» ë§‰ì•„ìš”!",
        "ğŸ˜ ëŠ¥ê¸€ë¯¸ ì¥ì°©. ë‹¹ì‹ ì€ ì—°ì• ì˜ ë§ˆìŠ¤í„°!",
        "ğŸ’¸ í˜„ì‹¤ì ì´ê³  ë“ ë“ í•œ íƒ€ì…. í•¨ê»˜ë¼ë©´ ë“ ë“ !",
        "ğŸ“± ì• ì • í­ë°œí˜•! í•˜ì§€ë§Œ ìˆ¨ ì‰´ ê³µê°„ë„ ì£¼ì„¸ìš” ğŸ’•",
        "ğŸŒŸ ì–´ë””ì„œë“  ë¹›ë‚˜ëŠ” ì¸ê¸°ì¸! ê³ ë°±ë§Œ ê¸°ë‹¤ë¦¬ë©´ ë!",
    ]
    st.success(f"âœ¨ {name or 'ìµëª…'}ë‹˜ì˜ ì´í‰ âœ¨\n\n{comments[idx]}")

    # ğŸ’ ì´ë¦„ ê¶í•© ê¸°ëŠ¥ ì¶”ê°€
    st.markdown("---")
    st.subheader("ğŸ’ ì´ë¦„ ê¶í•© í…ŒìŠ¤íŠ¸")

    partner = st.text_input("ğŸ’• ê¶í•©ì„ ë³´ê³  ì‹¶ì€ ì‚¬ëŒì˜ ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”", value="")

    if partner:
        # ë‹‰ë„¤ì„ + ìƒëŒ€ ì´ë¦„ì„ í•´ì‹œë¡œ ë³€í™˜ â†’ 0~100 ì ìˆ˜ ìƒì„±
        seed_str = f"{name}-{partner}"
        comp_score = int(sha256(seed_str.encode()).hexdigest(), 16) % 101  
        st.write(f"âœ¨ {name} ğŸ’– {partner} âœ¨ ì˜ ê¶í•© ì ìˆ˜ëŠ”...")
        st.markdown(f"<h2 style='text-align:center;'>ğŸ’˜ {comp_score}% ğŸ’˜</h2>", unsafe_allow_html=True)

        # ì ìˆ˜ë³„ ë©˜íŠ¸
        if comp_score >= 80:
            msg = "ì²œìƒì—°ë¶„ âœ¨ ë‘ ë¶„ì€ ìš´ëª… ê·¸ ìì²´ì˜ˆìš”!"
        elif comp_score >= 60:
            msg = "ì¢‹ì€ ì¼€ë¯¸ ğŸ’• ë…¸ë ¥í•˜ë©´ ì—°ì•  ì„±ê³µ!"
        elif comp_score >= 40:
            msg = "ê·¸ëŸ­ì €ëŸ­ ğŸ˜… ì„œë¡œ ì´í•´ê°€ í•„ìš”í•´ìš”"
        else:
            msg = "ğŸ˜¢ ì• ë§¤í•œ ì¸ì—°... í•˜ì§€ë§Œ ì¹œêµ¬ë¡œëŠ” ë”± ì¢‹ì•„ìš”!"
        
        st.success(msg)

else:
    st.info("ğŸ‘‰ ëª¨ë“  ë¬¸í•­ì„ ì„ íƒí•œ ë’¤ **ê²°ê³¼ ë³´ê¸° ğŸ’˜**ë¥¼ ëˆŒëŸ¬ì£¼ì„¸ìš”!")
